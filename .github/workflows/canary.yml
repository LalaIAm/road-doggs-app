name: Canary Tests

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

env:
  NODE_VERSION: '22.x'

jobs:
  canary-tests:
    name: External API Health Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            **/node_modules
          key: ${{ runner.os }}-npm-canary-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-canary-

      - name: Install dependencies
        run: npm ci

      - name: Install canary test dependencies
        run: |
          npm install --save-dev @google-cloud/vertexai

      - name: Run Vertex AI canary test
        run: node scripts/canary-test.js
        env:
          VERTEX_AI_PROJECT_ID: ${{ secrets.VERTEX_AI_PROJECT_ID }}
          VERTEX_AI_LOCATION: ${{ secrets.VERTEX_AI_LOCATION || 'us-central1' }}

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canary-test-logs
          path: |
            scripts/canary-test.js
          retention-days: 30
          if-no-files-found: ignore

      - name: Report results
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "## ✅ Canary Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All external API health checks completed successfully." >> $GITHUB_STEP_SUMMARY
            echo "- **Vertex AI**: ✅ PASS" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Canary Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more external API health checks failed." >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
